---
title: "Goose parameter fitting"
author: "Lars Dalby"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 8)
```

```{r load, echo=FALSE,message=FALSE, warning=FALSE, include=FALSE}
# 'rgl',
packs = c('data.table', 'ralmass', 'ggplot2', 'RColorBrewer', 'knitr',  'stringr', 'viridis')
sapply(packs, FUN = require, character.only = TRUE)
pathtodirs = 'e:/almass/WorkDirectories/Goose'
knitr::opts_chunk$set(echo = FALSE)
# knit_hooks$set(webgl = hook_webgl)
destdir = 'o:/ST_GooseProject/ALMaSS/GooseParameterFitting/'
doc = file.path(destdir, 'ParameterFittingGoose.html')
newname = paste0('ParameterFittingGoose', Sys.Date(), '.html')
if(file.exists(doc)) {
  file.copy(from = doc, to = file.path(destdir, newname), overwrite = TRUE)
}
# Read in the config so we can print the default values onto the plots
cfg = readLines('~/git/ALMaSS_inputs/GooseManagement/Vejlerne/TIALMaSSConfig.cfg')
```

```{r almassexe, echo=FALSE}
# wds = dir(pathtodirs)
# wds = wds[-grep('WD2', wds)]
# # wds = c("WD01", "WD02", "WD03", "WD04", "WD05", "WD06", "WD07", "WD09")
# exes = vector('list', length(wds))
# for (i in seq_along(wds)) {
#   exes[[i]] = file.info(paste(pathtodirs, wds[i], 'ALMaSS_CmdLine.exe', sep = '/'))$mtime
# }
# exe = unique(exes)

```

## Plots
The **Individual** panel is showing the individual fits (raw values) and the **Overall** panel is showing the average sum of the squared species specific fits.

```{r Remodel, echo=FALSE}
se = function(x) sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))
remodel = function(res, type = "minmax") {
	res[c(grep('PF', FitType), grep('PT', FitType), grep('Pinkfoot', FitType)), Species:='Pinkfoot']
  res[FitType == 'Weightfit', Species:='Pinkfoot']	
	res[c(grep('BN', FitType), grep('BT', FitType), grep('Barnacle', FitType)), Species:='Barnacle']
	res[c(grep('GL', FitType), grep('GT', FitType), grep('Greylag', FitType)), Species:='Greylag']
	res[FitType %in% c('BarnacleFit', 'GreylagFit', 'PinkfootFit'), FitType:='OverallFit']
	res[!FitType %in% c('Weightfit', 'OverallFit'), FitType:=str_sub(FitType, end = -3)]
	if(type == "minmax"){
	 res[, c("mean", "min", "max") := .(mean(Fit), min(Fit), max(Fit)), by = .(Parameter, Species, Value, FitType)] 
	}
	if(type == "sd"){
    res[, c("mean", "min", "max") := .(mean(Fit), mean - sd(Fit), mean + sd(Fit)), by = .(Parameter, Species, Value, FitType)]	  
	}
	if(type == "se"){
    res[, c("mean", "min", "max") := .(mean(Fit), mean - se(Fit), mean + se(Fit)), by = .(Parameter, Species, Value, FitType)]	  
	}
	fitres = unique(res[,.(Species, Parameter, Value, FitType, mean, min, max)])
	fitres[, Type:='Individual']
	fitres[FitType == 'OverallFit' , Type:='Overall']
	fitres[grep('Prop', FitType), Type:='Timings']
	return(fitres)
}

```


```{r ThePlots, echo=FALSE, fig.width=12}
allres = fread("/home/lars/temp/GooseParameterFitting_2017-01-11.txt")
# pdf(file = 'c:/Users/lada/Desktop/GPtoPrint2.pdf', width = 12, height = 8)
for (i in seq_along(allres[,unique(Parameter)])) {
	res = allres[Parameter == unique(Parameter)[i],]
 	param = res[,unique(Parameter)]
	res[FitType == 'PFBagOverlap', FitType:='BagOverlapPF']
	res[FitType == 'GLBagOverlap', FitType:='BagOverlapGL']
	res[FitType == 'PFTotalBag', FitType:='TotalBagPF']
	res[FitType == 'GLTotalBag', FitType:='TotalBagGL']
	res = remodel(res, type = "minmax")

	p = ggplot(res, aes(Value, mean)) +
	 geom_line(aes(color = FitType)) + 
	 geom_pointrange(aes(ymin = min, ymax = max, color = FitType)) + 
	 facet_grid(Species~Type, scales = 'free_y') + 
	 scale_color_viridis(discrete=TRUE) +
	 theme(legend.text=element_text(size=10)) +
	 theme_bw() +
	 ylab('Fit')
	if(length(param) == 1) {
		p = p + ggtitle(ConvertParam(param), subtitle = paste0('Default value: ', GetParamValue(cfg, param)))
	}
	if(length(param) > 1) {
		p = p + xlab(sapply(param, FUN = ConvertParam)) + ggtitle(sapply(param, FUN = ConvertParam))
	}
	print(p)
}
# dev.off()
```



























